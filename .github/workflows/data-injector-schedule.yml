name: Geomonitor Build + Deploy

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run_injector:
    name: üß† Inject data into Firebase
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: pip install requests geopy python-dotenv

      - name: Run data injector
        env:
          FIREBASE_URL: ${{ secrets.FIREBASE_URL }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          GEOAPIFY_KEY: ${{ secrets.GEOAPIFY_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: python data_injector.py

      - name: Prepare index.html for deploy (inject MapTiler key)
        env:
          MAPTILER_KEY: ${{ secrets.MAPTILER_KEY }}
        run: |
          echo "üîß Injecting MapTiler key into index.html (placeholder -> secret)"
          # make a copy to avoid modifying history on main; we deploy from workspace
          cp index.html index.html.deploy
          # replace placeholder
          sed -i "s|MAPTILER_KEY_PLACEHOLDER|$MAPTILER_KEY|g" index.html.deploy
          # show a tiny preview (first 6 lines) for logs (the key will be censored)
          echo "----- index.html.deploy preview -----"
          head -n 12 index.html.deploy
          echo "-------------------------------------"

      - name: Upload prepared site files
        uses: actions/upload-artifact@v4
        with:
          name: site-files
          path: |
            index.html.deploy
            app.js
            style.css
            # add other static assets you want to publish (images, fonts, etc.)

  deploy_site:
    name: üåê Deploy to GitHub Pages
    needs: run_injector
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download prepared site files
        uses: actions/download-artifact@v4
        with:
          name: site-files

      - name: Move prepared files into place
        run: |
          mv index.html.deploy index.html
          ls -la

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./
